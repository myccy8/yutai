<style>
    .news-line-box {
    }

        .news-line-box .news-name {
            font-family: Tahoma;
            margin-top: 5px;
        }

        .news-line-box .meetting-input {
            width: 300px;
        }
</style>

<div class="meeting-header">
    <span>添加二级导航单项</span>
</div>
<form id="formfile" action="/api/GoldGuideSecondaryNavigation/GoldGuideSecondaryNavigationAdd" method="post" enctype="multipart/form-data" name="formfile" target="submitSecondaryNavigation">
    <div class="news-line-box" id="load_select">

    </div>
    <input type="hidden" value="-1" name="_PrimaryNavigationID" id="_PrimaryNavigationID" />
    <div class="news-line-box">
        <div class="news-name formfile-label">
            名称：
        </div>
        <div class="news-content">
            <input class="meetting-input" type="text" id="txtSecondaryNavigationName" placeholder="请填写二级导航单项名称" name="SecondaryNavigationName" />
            <span id="spanSecondaryNavigationName" style="color:red"></span>
        </div>
    </div>
    <div class="news-line-box">
        <div class="meeting-name">
            导航图片：
        </div>
        <div class="news-content">
            <div class="upload_img" style="height: 137px; width: 148px;" id="preview_fake">
                <img id="preview" src="/Images/no-image.jpg" style=" width:130px; height: 130px;" />
            </div>
            <div class="upload_product">
                <input type="file" id="uploadfile" style=" position: absolute; opacity: 0; width: 76px; height: 30px; cursor: pointer;" name="Img" />
                <button class="upload_btn">
                    上传
                </button>
                <span id="spanImg" style="color:red"></span>
            </div>
        </div>
    </div>
    <div class="operate-nextBtn mt20">
        <input type="submit" value="添加" class="saveBtn" id="btnNext" />
        <!--返回上一页-->
        <input type="button" value="返回" class="saveBtn" id="btnBefore" />
    </div>
</form>
<iframe id="submitSecondaryNavigation" name="submitSecondaryNavigation" style="display:none;"></iframe>




<script id="PrimaryNavigationnametemp" type="text/x-jquery-tmpl">
    <select class="NewSelect" name="PrimaryNavSelect" id="typeSelect">
        {{if Data.length==0}}
        <option value="-1">选择一级菜单</option>
        {{/if}}
        {{each Data}}
        <option value="{{$value.primaryNavigationID}}">{{$value.primaryNavigationName}}</option>
        {{/each}}
    </select>
    <span id="_parentselect" style="color:red"></span>
</script>

<script type="text/javascript">
    function loadselect() {
        $.fspost('/api/GoldGuidePrimaryNavigation/GoldGuidePrimaryNavigationList').success(function (data) {
            $('#load_select').html(template('PrimaryNavigationnametemp', data));
             debugger
        })
    }
    //主入口
    $(function () {
        loadselect();
        $("#uploadfile").change(function () {
            change();
        });
        //返回上一页
        $("#btnBefore").click(function () {
            loadpage("/html/GoldGuide/GoldGuideSecondaryNavigationList.html");
        });
        $('#formfile').submit(function () {
          return  Add();
        })
    });
    function change() {
        var pic = document.getElementById("preview"),
            file = document.getElementById("uploadfile"),
            isIE6 = navigator.userAgent.match(/MSIE 6.0/) != null;
        if ("FileReader" in window) {
            html5Reader(file);
        }
        else {
            file.select();
            file.blur();
            var reallocalpath = document.selection.createRange().text;
            if (isIE6) {
                pic.src = reallocalpath;
            }
            else {
                pic.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
                pic.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src=\"" + reallocalpath + "\")";
            }
        }
    }
    function html5Reader(file) {
        var file = file.files[0];
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
            var pic = document.getElementById("preview");
            pic.src = this.result;
        }
    }
    function Add() {
        //进行检测
        $("#txtSecondaryNavigationName").focusout();
        if (!checkValNull("#txtSecondaryNavigationName")) {
            return false;
        }
        if ($("#typeSelect").val() == -1) {
            $("#_parentselect").text("请先添加一级菜单");
            return false;
        } else {
            $("#_parentselect").text("");
        };
        if ($("#uploadfile").val() == "" || $("#preview").attr("src") == "/Images/no-image.jpg") {
            $("#spanImg").text("图片不能为空");
            return false;
        } else {
            $("#spanImg").text("");
        };
        //开始请求
        var a = setInterval(function () {
            var val = $(top['submitSecondaryNavigation'].document.body).text();
            if (val) {
                clearInterval(a);
                alert("添加成功");
                $("#txtSecondaryNavigationName").val("");
                $("#preview").attr("src", "/Images/no-image.jpg");
            }
        }, 500);
    }


    /***focusout***/
    $("#txtSecondaryNavigationName").focusout(function () {
        if (!checkValNull($(this))) {
            $("#spanSecondaryNavigationName").text("二级导航单项名称不能为空");
        } else {
            $("#spanSecondaryNavigationName").text("");
        }
    });



    //检测表单元素是否为空
    function checkValNull($val) {
        if ($($val).val() == "") {
            return false;
        } else {
            return true;
        }
    }


</script>
